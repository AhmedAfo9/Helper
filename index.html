<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تدريب على الامتحان الشفوي الفارسي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* الخط الأساسي للتطبيق */
        body {
            font-family: 'Cairo', sans-serif;
            /* إزالة تأثير الوميض عند النقر على عناصر اللمس */
            -webkit-tap-highlight-color: transparent;
            /* منع التمرير على مستوى الجسم بالكامل */
            overflow: hidden; 
        }
        /* حاوية التطبيق الرئيسية لتخطيط مرن */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh; /* ارتفاع كامل للشاشة */
            max-height: 100vh; /* ضمان عدم تجاوز الارتفاع */
        }
        /* المحتوى الرئيسي القابل للتمرير */
        main {
            flex-grow: 1; /* يأخذ كل المساحة المتاحة */
            overflow-y: auto; /* تمكين التمرير فقط للمحتوى الرئيسي */
            padding-bottom: 80px; /* مسافة سفلية لشريط التنقل الثابت */
            /* Ensure main content takes full width */
            width: 100%;
            box-sizing: border-box; /* Include padding in element's total width and height */
        }
        /* أنيميشن قلب البطاقة */
        .card-flip-inner {
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); /* انتقال سلس */
            transform-style: preserve-3d; /* للحفاظ على ثلاثية الأبعاد أثناء القلب */
        }
        .card.flipped .card-flip-inner {
            transform: rotateY(180deg); /* قلب البطاقة 180 درجة */
        }
        /* إخفاء الوجه الخلفي للبطاقة عند عدم القلب */
        .card-front, .card-back {
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 0.75rem; /* تطابق حواف البطاقة */
        }
        .card-back {
            transform: rotateY(180deg); /* تدوير الوجه الخلفي ليكون مرئياً عند القلب */
        }
        /* نمط عنصر التنقل النشط */
        .nav-item.active {
            background-color: #6366f1; /* لون أزرق جذاب */
            color: white;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3); /* ظل خفيف */
            transform: translateY(-5px); /* تأثير رفع خفيف */
        }
        /* شريط التمرير المخصص لتحسين المظهر */
        main::-webkit-scrollbar {
            width: 8px;
        }
        main::-webkit-scrollbar-track {
            background: #f1f5f9; /* لون خلفية شريط التمرير */
        }
        main::-webkit-scrollbar-thumb {
            background: #a78bfa; /* لون مقبض شريط التمرير (بنفسجي فاتح) */
            border-radius: 10px;
        }
        main::-webkit-scrollbar-thumb:hover {
            background: #8b5cf6; /* لون مقبض شريط التمرير عند التحويم */
        }

        /* أنماط إضافية لأزرار الاختبار */
        .quiz-option {
            transition: all 0.2s ease-in-out; /* انتقال سلس لجميع الخصائص */
        }
        .quiz-option:hover {
            transform: translateY(-2px); /* تأثير رفع خفيف عند التحويم */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* ظل أكبر عند التحويم */
        }

        /* Ensure quiz page content takes full available width */
        #quiz-page {
            width: 100%;
            box-sizing: border-box;
            padding: 1rem; /* Add some padding for content */
            /* Removed flex centering and height to allow natural flow within main */
        }
        #quiz-container {
            width: 100%; /* Ensure quiz container takes full width */
            max-width: 400px; /* Optional: limit max width for larger screens */
            margin: 0 auto; /* Center the quiz container */
        }

        /* Splash Screen Styles */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom right, #6366f1, #a855f7); /* تدرج لوني جذاب */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* تأكد من أنها في المقدمة */
            opacity: 1;
            transition: opacity 0.5s ease-out; /* انتقال لاختفاء سلس */
        }

        #splash-screen.fade-out {
            opacity: 0;
            pointer-events: none; /* تعطيل التفاعل بعد الاختفاء */
        }

        .splash-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            transform: scale(0.5); /* تبدأ صغيرة */
            opacity: 0; /* تبدأ شفافة */
            animation: splash-grow 1.5s ease-out forwards 0.5s; /* أنيميشن النمو والظهور */
        }

        @keyframes splash-grow {
            to {
                transform: scale(1); /* تكبر إلى الحجم الطبيعي */
                opacity: 1; /* تصبح مرئية بالكامل */
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-100 text-slate-800">

    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="splash-content">
            <h1 class="text-5xl font-bold mb-4">مُعينك في الفارسية</h1>
            <p class="text-2xl font-semibold">بواسطة: أحمد فلاح</p>
        </div>
    </div>

    <div id="app" class="max-w-md mx-auto bg-white shadow-2xl rounded-xl overflow-hidden app-container hidden">
        
        <!-- Header (Fixed) -->
        <header class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white p-4 text-center shadow-lg flex-shrink-0">
            <h1 class="text-2xl font-bold tracking-wide">مُعينك في الفارسية</h1>
            <p class="text-sm opacity-90 mt-1">تدرب على امتحانك الشفوي بثقة</p>
        </header>

        <!-- Main Content (Scrollable) -->
        <main id="main-content" class="p-4 relative">
            <!-- Home Page (Section List) -->
            <div id="home-page">
                <h2 class="text-xl font-bold mb-5 text-indigo-800 border-b-2 border-indigo-200 pb-2">أقسام المذاكرة</h2>
                <div id="sections-container" class="grid grid-cols-1 gap-4">
                    <!-- Sections will be dynamically inserted here -->
                </div>
            </div>

            <!-- Questions Page -->
            <div id="questions-page" class="hidden">
                <button id="back-to-home" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-full mb-5 hover:bg-slate-300 transition-colors flex items-center shadow-md">
                    <span class="ml-2 text-lg">&larr;</span> العودة للأقسام
                </button>
                <h2 id="questions-title" class="text-xl font-bold mb-5 text-indigo-800 border-b-2 border-indigo-200 pb-2"></h2>
                <div id="questions-container" class="space-y-4">
                    <!-- Question cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Quiz Page -->
            <div id="quiz-page" class="hidden">
                <div id="quiz-container" class="w-full">
                    <!-- Quiz content will be dynamically inserted here -->
                </div>
            </div>

        </main>

        <!-- Navigation Bar (Fixed) -->
        <nav class="bg-white shadow-[0_-8px_20px_rgba(0,0,0,0.08)] p-3 flex justify-around rounded-t-3xl flex-shrink-0 border-t border-slate-100">
            <button data-page="home-page" class="nav-item flex-1 text-center text-slate-500 p-2 rounded-xl transition-all duration-300 flex flex-col items-center justify-center active">
                <span class="block text-2xl mb-1">📚</span>
                <span class="text-xs font-semibold">الأقسام</span>
            </button>
            <button data-page="quiz-page" class="nav-item flex-1 text-center text-slate-500 p-2 rounded-xl transition-all duration-300 flex flex-col items-center justify-center">
                <span class="block text-2xl mb-1">✏️</span>
                <span class="text-xs font-semibold">الاختبار</span>
            </button>
        </nav>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA ---
            const combinedQuestions = [
                // Category 1: Personal Information and Introduction
                { category: "المعلومات الشخصية والتعارف", persianQ: "لطفاً خودتان را <span class='text-red-500 font-bold'>معرفی کنید</span>.", arabicQ: "من فضلك، عرف بنفسك.", persianA: "اسم من [أحمد] است، [سی] ساله و اهل عراق هستم." },
                { category: "المعلومات الشخصية والتعارف", persianQ: "<span class='text-red-500 font-bold'>اسم</span> شما چیست؟", arabicQ: "ما اسمك؟", persianA: "اسم من [أحمد] است." },
                { category: "المعلومات الشخصية والتعارف", persianQ: "<span class='text-red-500 font-bold'>فامیلی</span> شما چیست؟", arabicQ: "ما هو لقبك؟", persianA: "فامیلی من [الکنانی] است." },
                { category: "المعلومات الشخصية والتعارف", persianQ: "شما اهل <span class='text-red-500 font-bold'>کجا</span> هستید؟", arabicQ: "من أي بلد أنت؟", persianA: "من اهل عراق هستم." },
                { category: "المعلومات الشخصية والتعارف", persianQ: "<span class='text-red-500 font-bold'>شغل</span> شما چیست؟ / <span class='text-red-500 font-bold'>چکاره</span> هستید؟", arabicQ: "ما هي مهنتك؟ / ماذا تعمل؟", persianA: "من دانشجو هستم." },
                { category: "المعلومات الشخصية والتعارف", persianQ: "<span class='text-red-500 font-bold'>چند سال</span> دارید؟ / چند ساله هستی؟", arabicQ: "كم عمرك؟", persianA: "من بیست و پنج سال دارم." },
                { category: "المعلومات الشخصية والتعارف", persianQ: "در کدام <span class='text-red-500 font-bold'>شهر</span> زندگی میکنید؟", arabicQ: "في أي مدينة تعيش؟", persianA: "من در شهر [بغداد] زندگی میکنم." },
                { category: "المعلومات الشخصية والتعارف", persianQ: "<span class='text-red-500 font-bold'>شماره تلفن</span> شما چند است؟", arabicQ: "ما هو رقم هاتفك؟", persianA: "شماره تلفن من [۰۷۷۱۲۳۴۵۶۷۸] است." },
                { category: "المعلومات الشخصية والتعارف", persianQ: "آیا شما <span class='text-red-500 font-bold'>متأهل</span> هستید یا <span class='text-red-500 font-bold'>مجرد</span>؟", arabicQ: "هل أنت متزوج أم أعزب؟", persianA: "من مجرد هستم." },
                { category: "المعلومات الشخصية والتعارف", persianQ: "چه <span class='text-red-500 font-bold'>زبانهایی</span> صحبت میکنید؟", arabicQ: "ما هي اللغات التي تتحدث بها؟", persianA: "من به زبان عربی و کمی فارسی صحبت میکنم." },
                { category: "المعلومات الشخصية والتعارف", persianQ: "<span class='text-red-500 font-bold'>زبان</span> شما چیست؟", arabicQ: "ما هي لغتك (الأم)؟", persianA: "زبان من عربی است." },
                { category: "المعلومات الشخصية والتعارف", persianQ: "آیا شما <span class='text-red-500 font-bold'>فارسی</span> صحبت میکنید؟", arabicQ: "هل تتحدث الفارسية؟", persianA: "بله، من کمی فارسی صحبت میکنم." },
                { category: "المعلومات الشخصية والتعارف", persianQ: "<span class='text-red-500 font-bold'>حال</span> شما چطور است؟ / خوبی؟", arabicQ: "كيف حالك؟ (رسمي / غير رسمي)", persianA: "خوبم، ممنون. شما چطورید؟" },
                { category: "المعلومات الشخصية والتعارف", persianQ: "<span class='text-red-500 font-bold'>رنگ</span> مورد علاقه شما چیست؟", arabicQ: "ما هو لونك المفضل؟", persianA: "رنگ مورد علاقه من آبی است." },
                
                // Category 2: Family and Friends
                { category: "العائلة والأصدقاء", persianQ: "خانواده شما <span class='text-red-500 font-bold'>چند نفر</span> هستند؟", arabicQ: "كم عدد أفراد عائلتك؟", persianA: "خانواده من [پنج] نفر هستند." },
                { category: "العائلة والأصدقاء", persianQ: "شما چند <span class='text-red-500 font-bold'>خواهر و برادر</span> دارید؟", arabicQ: "كم أخ وأخت لديك؟", persianA: "من یک خواهر و دو برادر دارم." },
                { category: "العائلة والأصدقاء", persianQ: "<span class='text-red-500 font-bold'>شغل پدر و مادر</span> شما چیست؟", arabicQ: "ما هي مهنة والديك؟", persianA: "پدر من بازنشسته است و مادر من خانه دار است." },
                { category: "العائلة والأصدقاء", persianQ: "<span class='text-red-500 font-bold'>بهترین دوست</span> شما کیست؟", arabicQ: "من هو أفضل صديق لديك؟", persianA: "بهترین دوست من علی است." },
                { category: "العائلة والأصدقاء", persianQ: "دوست شما <span class='text-red-500 font-bold'>چه جور آدمی</span> است؟", arabicQ: "أي نوع من الأشخاص هو صديقك؟", persianA: "او آدم خیلی مهربان و خوش اخلاقی است." },
                { category: "العائلة والأصدقاء", persianQ: "<span class='text-red-500 font-bold'>دوستان</span> شما اهل کجا هستند؟", arabicQ: "أصدقاؤك من أي بلد؟", persianA: "دوستان من اهل عراق و ایران هستند." },
                { category: "العائلة والأصدقاء", persianQ: "برادر شما از شما <span class='text-red-500 font-bold'>بزرگتر</span> است یا <span class='text-red-500 font-bold'>کوچکتر</span>؟", arabicQ: "هل أخوك أكبر منك أم أصغر؟", persianA: "برادر من از من بزرگتر است." },
                { category: "العائلة والأصدقاء", persianQ: "<span class='text-red-500 font-bold'>مادر</span> شما چکاره است؟", arabicQ: "ماذا تعمل والدتك؟", persianA: "مادر من خانه دار است." },
                { category: "العائلة والأصدقاء", persianQ: "پدر و مادر شما <span class='text-red-500 font-bold'>چند سال</span> دارند؟", arabicQ: "كم عمر والديك؟", persianA: "پدرم پنجاه و دو ساله و مادرم چهل و هشت ساله است." },
                { category: "العائلة والأصدقاء", persianQ: "آیا شما <span class='text-red-500 font-bold'>عمو يا عمه</span> دارید؟", arabicQ: "هل لديك عم أو عمة؟", persianA: "بله، من دو عمو و یک عمه دارم." },
                { category: "العائلة والأصدقاء", persianQ: "آیا شما <span class='text-red-500 font-bold'>خاله یا دایی</span> دارید؟", arabicQ: "هل لديك خالة أو خال؟", persianA: "بله، من دو خاله و سه دایی دارم." },
                { category: "العائلة والأصدقاء", persianQ: "آیا شما <span class='text-red-500 font-bold'>فرزند</span> دارید؟", arabicQ: "هل لديك أطفال؟", persianA: "نه، من فرزند ندارم." },
                { category: "العائلة والأصدقاء", persianQ: "دوست شما <span class='text-red-500 font-bold'>اهل کجاست</span> و <span class='text-red-500 font-bold'>شغلش</span> چیست؟", arabicQ: "صديقك من أين وما هي مهنته؟", persianA: "دوست من اهل ترکیه و معلم است." },

                // Category 3: Daily Routine and Hobbies
                { category: "الروتين اليومي والهوايات", persianQ: "شما هر روز ساعت چند از خواب <span class='text-red-500 font-bold'>بیدار میشوید</span>؟", arabicQ: "في أي ساعة تستيقظ كل يوم؟", persianA: "من هر روز ساعت شش و نیم صبح بیدار میشوم." },
                { category: "الروتين اليومي والهوايات", persianQ: "بعد از بیدار شدن <span class='text-red-500 font-bold'>چه کار میکنید</span>؟", arabicQ: "ماذا تفعل بعد الاستيقاظ؟", persianA: "من بعد از بیدار شدن مسواک میزنم و نماز میخوانم." },
                { category: "الروتين اليومي والهوايات", persianQ: "شما معمولاً <span class='text-red-500 font-bold'>عصرها</span> چه کار می کنی؟", arabicQ: "ماذا تفعل عادة في فترة العصر؟", persianA: "من معمولا عصرها ورزش میکنم." },
                { category: "الروتين اليومي والهوايات", persianQ: "شما شب ها <span class='text-red-500 font-bold'>چه کار میکنید</span>؟", arabicQ: "ماذا تفعل في المساء؟", persianA: "من شبها تلویزیون تماشا میکنم یا با خانواده صحبت میکنم." },
                { category: "الروتين اليومي والهوايات", persianQ: "ساعت چند <span class='text-red-500 font-bold'>میخوابید</span>؟", arabicQ: "في أي ساعة تنام؟", persianA: "من معمولاً ساعت یازده شب میخوابم." },
                { category: "الروتين اليومي والهوايات", persianQ: "<span class='text-red-500 font-bold'>سرگرمی</span> شما چیست؟ / در <span class='text-red-500 font-bold'>اوقات فراغت</span> چه کار میکنید؟", arabicQ: "ما هي هوايتك؟ / ماذا تفعل في أوقات فراغك؟", persianA: "من در اوقات فراغت ورزش میکنم و کتاب میخوانم." },
                { category: "الروتين اليومي والهوايات", persianQ: "شما چه <span class='text-red-500 font-bold'>ورزشی</span> را دوست دارید؟", arabicQ: "أي رياضة تحب؟", persianA: "من فوتبال و شنا را دوست دارم." },
                { category: "الروتين اليومي والهوايات", persianQ: "<span class='text-red-500 font-bold'>آخر هفته ها</span> چه کار میکنید؟", arabicQ: "ماذا تفعل في عطلة نهاية الأسبوع؟", persianA: "جمعه ها با خانواده به پارک میروم." },
                { category: "الروتين اليومي والهوايات", persianQ: "شما هر چند وقت یک بار <span class='text-red-500 font-bold'>ورزش</span> میکنید؟", arabicQ: "كم مرة تمارس الرياضة؟", persianA: "من هفته ای سه بار ورزش میکنم." },
                { category: "الروتين اليومي والهوايات", persianQ: "آیا شما <span class='text-red-500 font-bold'>کتاب</span> میخوانید؟", arabicQ: "هل تقرأ الكتب؟", persianA: "بله، من هر شب قبل از خواب کتاب میخوانم." },
                { category: "الروتين اليومي والهوايات", persianQ: "شما به <span class='text-red-500 font-bold'>موسیقی</span> گوش میدهید؟", arabicQ: "هل تستمع إلى الموسيقى؟", persianA: "بله، من موسیقی را خیلی دوست دارم." },
                { category: "الروتين اليومي والهوايات", persianQ: "شما معمولاً با چه کسی به <span class='text-red-500 font-bold'>سینما</span> میروید؟", arabicQ: "مع من تذهب إلى السينما عادة؟", persianA: "من معمولاً با دوستانم به سینما میروم." },
                { category: "الروتين اليومي والهوايات", persianQ: "در کشور شما مردم در <span class='text-red-500 font-bold'>عید فطر</span> چه کار میکنند؟", arabicQ: "في بلدك، ماذا يفعل الناس في عيد الفطر؟", persianA: "در کشور من مردم نماز میخوانند و به دیدن خانواده میروند." },

                // Category 4: Food, Clothing, and Shopping
                { category: "الطعام والملابس والتسوق", persianQ: "<span class='text-red-500 font-bold'>صبحانه</span> چه میخورید؟", arabicQ: "ماذا تتناول على الفطور؟", persianA: "من برای صبحانه نان و پنیر و چای میخورم." },
                { category: "الطعام والملابس والتسوق", persianQ: "شما معمولاً چه ساعتی <span class='text-red-500 font-bold'>ناهار</span> میخورید؟", arabicQ: "في أي ساعة تتناول الغداء عادة؟", persianA: "من معمولاً ساعت دو بعد از ظهر ناهار میخورم." },
                { category: "الطعام والملابس والتسوق", persianQ: "<span class='text-red-500 font-bold'>غذای</span> مورد علاقه شما چیست؟", arabicQ: "ما هو طعامك المفضل؟", persianA: "غذای مورد علاقه من چلو کباب است." },
                { category: "الطعام والملابس والتسوق", persianQ: "آیا شما غذای <span class='text-red-500 font-bold'>ایرانی</span> دوست دارید؟", arabicQ: "هل تحب الطعام الإيراني؟", persianA: "بله، من غذای ایرانی خیلی دوست دارم." },
                { category: "الطعام والملابس والتسوق", persianQ: "شما چه <span class='text-red-500 font-bold'>نوشیدنی</span> دوست دارید؟", arabicQ: "ما هو مشروبك المفضل؟", persianA: "من چای و آب پرتقال دوست دارم." },
                { category: "الطعام والملابس والتسوق", persianQ: "<span class='text-red-500 font-bold'>این چند است؟</span> / قیمتش چنده؟", arabicQ: "كم سعر هذا؟", persianA: "این پنجاه هزار تومان است." },
                { category: "الطعام والملابس والتسوق", persianQ: "شما از کجا <span class='text-red-500 font-bold'>لباس</span> میخرید؟", arabicQ: "من أين تشتري ملابسك؟", persianA: "من از [بازار] لباس میخرم." },
                { category: "الطعام والملابس والتسوق", persianQ: "شما چه رنگ <span class='text-red-500 font-bold'>لباسی</span> را بیشتر میپوشید؟", arabicQ: "ما لون الملابس الذي ترتديه أكثر؟", persianA: "من بیشتر لباسهای تیره میپوشم." },
                { category: "الطعام والملابس والتسوق", persianQ: "وقتی به <span class='text-red-500 font-bold'>مهمانی</span> میروید، چه لباسی میپوشید؟", arabicQ: "عندما تذهب إلى حفلة، ماذا ترتدي؟", persianA: "من وقتی به مهمانی میروم معمولاً کت و شلوار میپوشم." },

                // Category 5: Time, Date, and Seasons
                { category: "الوقت والتاريخ والفصول", persianQ: "<span class='text-red-500 font-bold'>ساعت چند</span> است؟ / ساعت چنده؟", arabicQ: "كم الساعة؟", persianA: "ساعت ده و ربع است." },
                { category: "الوقت والتاريخ والفصول", persianQ: "امروز <span class='text-red-500 font-bold'>چند شنبه</span> است؟", arabicQ: "أي يوم هو اليوم؟", persianA: "امروز سه شنبه است." },
                { category: "الوقت والتاريخ والفصول", persianQ: "امروز <span class='text-red-500 font-bold'>چندم</span> است؟", arabicQ: "كم تاريخ اليوم؟", persianA: "امروز [بیست و یکم] [ژوئیه] است." },
                { category: "الوقت والتاريخ والفصول", persianQ: "<span class='text-red-500 font-bold'>فردا</span> چه روزی است؟", arabicQ: "أي يوم هو غدًا؟", persianA: "فردا چهارشنبه است." },
                { category: "الوقت والتاريخ والفصول", persianQ: "<span class='text-red-500 font-bold'>تاریخ تولد</span> شما کی است؟", arabicQ: "متى تاريخ ميلادك؟", persianA: "تاریخ تولد من بیست و هفتم ماه مه سال ۱۹۹۵ است." },
                { category: "الوقت والتاريخ والفصول", persianQ: "شما متولد چه <span class='text-red-500 font-bold'>سالی</span> هستید؟", arabicQ: "في أي سنة ولدت؟", persianA: "من متولد سال ۱۹۹۵ میلادی هستم." },
                { category: "الوقت والتاريخ والفصول", persianQ: "در کدام <span class='text-red-500 font-bold'>فصل</span> به دنیا آمدید؟", arabicQ: "في أي فصل ولدت؟", persianA: "من در فصل بهار به دنیا آمدم." },
                { category: "الوقت والتاريخ والفصول", persianQ: "<span class='text-red-500 font-bold'>هوای</span> امروز چطور است؟", arabicQ: "كيف هو طقس اليوم؟", persianA: "هوای امروز آفتابی و گرم است." },
                { category: "الوقت والتاريخ والفصول", persianQ: "در شهر شما هوا در <span class='text-red-500 font-bold'>زمستان</span> چطور است؟", arabicQ: "في مدينتك، كيف هو الطقس في الشتاء؟", persianA: "در شهر من هوا در زمستان سرد و بارانی است." },
                { category: "الوقت والتاريخ والفصول", persianQ: "چه <span class='text-red-500 font-bold'>فصلی</span> را دوست دارید؟ چرا؟", arabicQ: "أي فصل تحب؟ لماذا؟", persianA: "من فصل پاییز را دوست دارم چون هوا خنک و دلپذیر است." },
                
                // Category 6: Directions and Addresses
                { category: "الاتجاهات والعناوين", persianQ: "<span class='text-red-500 font-bold'>آدرس</span> شما کجاست؟", arabicQ: "ما هو عنوانك؟", persianA: "خیابان آزادی، کوچه دوم، پلاک ده." },
                { category: "الاتجاهات والعناوين", persianQ: "ببخشید، <span class='text-red-500 font-bold'>ایستگاه اتوبوس</span> کجاست؟", arabicQ: "عفواً، أين محطة الحافلات؟", persianA: "مستقیم برو، سمت راست." },
                { category: "الاتجاهات والعناوين", persianQ: "چطور میتوانم به <span class='text-red-500 font-bold'>بانک</span> بروم؟", arabicQ: "كيف يمكنني الذهاب إلى البنك؟", persianA: "مستقیم بروید، بعد از چهار راه بپیچید سمت چپ." },
                { category: "الاتجاهات والعناوين", persianQ: "برای رفتن به <span class='text-red-500 font-bold'>مرکز شهر</span> باید به راست بپیچم یا چپ؟", arabicQ: "للذهاب إلى مركز المدينة، هل أنعطف يميناً أم يساراً؟", persianA: "باید به راست بپیچید." },
                { category: "الاتجاهات والعناوين", persianQ: "<span class='text-red-500 font-bold'>کتابخانه</span> کجاست؟", arabicQ: "أين المكتبة؟", persianA: "کتابخانه روبروی پارک است." },
                { category: "الاتجاهات والعناوين", persianQ: "شما با <span class='text-red-500 font-bold'>چی</span> به دانشگاه میروید؟", arabicQ: "بماذا تذهب إلى الجامعة؟", persianA: "من با اتوبوس به دانشگاه میروم." },

                // Category 7: Future Plans
                { category: "الخطط المستقبلية", persianQ: "شما <span class='text-red-500 font-bold'>فردا</span> چه کار میکنید؟", arabicQ: "ماذا ستفعل غداً؟", persianA: "من فردا میخواهم به کتابخانه بروم." },
                { category: "الخطط المستقبلية", persianQ: "<span class='text-red-500 font-bold'>آخر هفته ی آینده</span> میخواهید چه کار کنید؟", arabicQ: "ماذا تريد أن تفعل في عطلة نهاية الأسبوع القادمة؟", persianA: "من میخواهم آخر هفته آینده دوستانم را ببینم." },
                { category: "الخطط المستقبلية", persianQ: "برای <span class='text-red-500 font-bold'>تعطیلات</span> چه برنامه ای دارید؟", arabicQ: "ما هي خطتك للعطلة؟", persianA: "من برای تعطیلات میخواهم به یک شهر دیگر سفر کنم." },
                { category: "الخطط المستقبلية", persianQ: "شما میخواهید در <span class='text-red-500 font-bold'>آینده</span> چه کاره شوید؟", arabicQ: "ماذا تريد أن تصبح في المستقبل؟", persianA: "من میخواهم در آینده استاد دانشگاه شوم." },
                { category: "الخطط المستقبلية", persianQ: "<span class='text-red-500 font-bold'>بعد از امتحان</span> میخواهید چه کار کنید؟", arabicQ: "ماذا تريد أن تفعل بعد الامتحان؟", persianA: "من میخواهم بعد از امتحان استراحت کنم." },
                { category: "الخطط المستقبلية", persianQ: "بعد از این <span class='text-red-500 font-bold'>کلاس</span> چه کار میخواهید بکنید؟", arabicQ: "ماذا تريد أن تفعل بعد هذا الصف؟", persianA: "بعد از این کلاس میخواهم به خانه بروم و استراحت کنم." },
                { category: "الخطط المستقبلية", persianQ: "آیا میخواهید به <span class='text-red-500 font-bold'>ایران</span> سفر کنید؟", arabicQ: "هل تريد أن تسافر إلى إيران؟", persianA: "بله، من خیلی دوست دارم به ایران سفر کنم." },
                
                // Category 8: Description, Comparison, and Opinions
                { category: "الوصف والمقارنة والآراء", persianQ: "اتاق شما <span class='text-red-500 font-bold'>چه شکلی</span> است؟", arabicQ: "كيف تبدو غرفتك؟", persianA: "اتاق من کوچک است اما یک پنجره بزرگ دارد." },
                { category: "الوصف والمقارنة والآراء", persianQ: "خانه شما <span class='text-red-500 font-bold'>بزرگ</span> است یا <span class='text-red-500 font-bold'>کوچک</span>؟", arabicQ: "هل منزلك كبير أم صغير؟", persianA: "خانه ما بزرگ است و یک حیاط قشنگ دارد." },
                { category: "الوصف والمقارنة والآراء", persianQ: "به نظر شما تهران <span class='text-red-500 font-bold'>بزرگتر</span> است یا بغداد؟", arabicQ: "برأيك هل طهران أكبر أم بغداد؟", persianA: "به نظر من تهران از بغداد بزرگتر و شلوغ تر است." },
                { category: "الوصف والمقارنة والآراء", persianQ: "چرا شما <span class='text-red-500 font-bold'>زبان فارسی</span> میخوانید؟", arabicQ: "لماذا تدرس اللغة الفارسية؟", persianA: "چون من به فرهنگ و ادبیات ایران علاقه دارم." },
                { category: "الوصف والمقارنة والآراء", persianQ: "آیا خانه شما به محل کارتان <span class='text-red-500 font-bold'>نزدیک</span> است؟", arabicQ: "هل منزلك قريب من مكان عملك؟", persianA: "بله، خانه من به محل کارم نزدیک است." },

                // Category 9: Past and Yesterday's Activities (new)
                { category: "الماضي وأنشطة الأمس", persianQ: "شما <span class='text-red-500 font-bold'>دیروز</span> چه کار کردید؟", arabicQ: "ماذا فعلت بالأمس؟", persianA: "من دیروز به دوستم تلفن زدم و با او صحبت کردم." },
                { category: "الماضي وأنشطة الأمس", persianQ: "<span class='text-red-500 font-bold'>دیروز</span> کجا رفتید؟", arabicQ: "إلى أین ذهبت بالأمس؟", persianA: "من دیروز به بازار رفتم و کمی خرید کردم." },
                { category: "الماضي وأنشطة الأمس", persianQ: "<span class='text-red-500 font-bold'>دیشب شام</span> چی خوردید؟", arabicQ: "ماذا أکلت على العشاء اللیلة الماضیة؟", persianA: "من دیشب برای شام کباب خوردم." },
                { category: "الماضي وأنشطة الأمس", persianQ: "<span class='text-red-500 font-bold'>آخر هفته ی گذشته</span> چه کار کردید؟", arabicQ: "ماذا فعلت في عطلة نهاية الأسبوع الماضية؟", persianA: "من آخر هفته گذشته با خانواده ام به رستوران رفتم." },
                { category: "الماضي وأنشطة الأمس", persianQ: "<span class='text-red-500 font-bold'>پارسال</span> کجا سفر کردید؟", arabicQ: "إلى أین سافرت العام الماضي؟", persianA: "من پارسال به شمال عراق سفر کردم." },
                { category: "الماضي وأنشطة الأمس", persianQ: "<span class='text-red-500 font-bold'>دیشب</span> ساعت چند خوابیدید؟", arabicQ: "في أي ساعة نمت اللیلة الماضیة؟", persianA: "من دیشب کمی دیر، ساعت دوازده خوابیدم." },
                { category: "الماضي وأنشطة الأمس", persianQ: "<span class='text-red-500 font-bold'>دیروز</span> چندم بود؟", arabicQ: "کم کان تاریخ الأمس؟", persianA: "دیروز بیستم بود." },
                { category: "الماضي وأنشطة الأمس", persianQ: "<span class='text-red-500 font-bold'>کی</span> به ایران سفر کردی؟", arabicQ: "متى سافرت إلى إيران؟", persianA: "ماه قبل به ایران سفر کردم." },
                { category: "الماضي وأنشطة الأمس", persianQ: "هوا چطور <span class='text-red-500 font-bold'>بود</span>؟", arabicQ: "كيف كان الطقس؟", persianA: "هوا خنک بود." },
            ];
            
            const verbs = [
                { persian: "درس میخوانم.", arabic: "أنا أدرس." },
                { persian: "ورزش میکنم.", arabic: "أنا أمارس الرياضة." },
                { persian: "صبحانه میخورم.", arabic: "أنا أتناول الفطور." },
                { persian: "ناهار میخورم.", arabic: "أنا أتناول الغداء." },
                { persian: "شام میخورم.", arabic: "أنا أتناول العشاء." },
                { persian: "کتاب میخوانم.", arabic: "أنا أقرأ كتابًا." },
                { persian: "کار میکنم.", arabic: "أنا أعمل." },
                { persian: "میخوابم.", arabic: "أنا أنام." },
                { persian: "لباس میپوشم.", arabic: "أنا أرتدي ملابس." },
                { persian: "به دانشگاه میروم.", arabic: "أنا أذهب إلى الجامعة." },
                { persian: "فیلم میبینم.", arabic: "أنا أشاهد فيلمًا." },
                { persian: "خرید میکنم.", arabic: "أنا أتسوق." },
                { persian: "آب مینوشم.", arabic: "أنا أشرب ماء." },
                { persian: "نامه مینویسم.", arabic: "أنا أكتب رسالة." },
                { persian: "تلویزیون تماشا میکنم.", arabic: "أنا أشاهد التلفاز." },
                { persian: "به بازار رفتم.", arabic: "ذهبت إلى السوق." },
                { persian: "کباب خوردم.", arabic: "أكلت كباب." },
            ];

            // --- DE-DUPLICATION LOGIC ---
            const uniqueQuestions = Array.from(new Map(combinedQuestions.map(item => [item.persianQ.replace(/<[^>]*>/g, '').trim(), item])).values());
            const data = uniqueQuestions;

            // --- ELEMENTS ---
            const splashScreen = document.getElementById('splash-screen');
            const appContainer = document.getElementById('app');
            const sectionsContainer = document.getElementById('sections-container');
            const questionsContainer = document.getElementById('questions-container');
            const questionsTitle = document.getElementById('questions-title');
            const quizContainer = document.getElementById('quiz-container');
            const navItems = document.querySelectorAll('.nav-item');
            const pages = {
                'home-page': document.getElementById('home-page'),
                'questions-page': document.getElementById('questions-page'),
                'quiz-page': document.getElementById('quiz-page')
            };
            const backToHomeBtn = document.getElementById('back-to-home');


            // --- STATE ---
            let currentQuizQuestionIndex = -1;
            let questionsForQuiz = [];
            // 'persianAnswer', 'arabicTranslation', 'persianVerb', 'arabicVerb', 'verbCompletionMC'
            let currentQuizType = ''; 
            let correctAnswersCount = 0;
            let wrongAnswersList = [];

            // --- FUNCTIONS ---

            // Function to normalize text for comparison (handle similar-looking characters, remove diacritics, trim, lowercase)
            const normalizeText = (text) => {
                if (!text) return '';
                // Replace Farsi Yeh (U+06cc) with Arabic Yeh (U+064a)
                // Replace Farsi Keh (U+06a9) with Arabic Keh (U+0643)
                // Remove all diacritics (harakat)
                // Remove all whitespace and convert to lowercase
                return text.replace(/ی/g, 'ي')
                           .replace(/ک/g, 'ك')
                           .normalize("NFD").replace(/[\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7-\u06ED]/g, '') // Remove Arabic diacritics
                           .replace(/\s+/g, '') // Remove all whitespace
                           .toLowerCase();
            };

            const showPage = (pageId) => {
                Object.values(pages).forEach(page => page.classList.add('hidden'));
                if (pages[pageId]) {
                    pages[pageId].classList.remove('hidden');
                }
                navItems.forEach(item => {
                    item.classList.toggle('active', item.dataset.page === pageId);
                });

                if (pageId === 'quiz-page') {
                    showQuizTypeSelection();
                }
                document.getElementById('main-content').scrollTop = 0;
            };

            const createSectionButton = (categoryName, icon) => {
                const button = document.createElement('button');
                button.className = 'bg-white p-4 rounded-xl shadow-md border border-slate-200 text-right hover:bg-indigo-50 hover:border-indigo-400 transition-all duration-300 flex items-center space-x-4 space-x-reverse transform hover:scale-105';
                button.innerHTML = `
                    <span class="text-3xl">${icon}</span>
                    <span class="font-semibold text-slate-700 text-lg">${categoryName}</span>
                `;
                button.onclick = () => showQuestions(categoryName);
                return button;
            };

            const displaySections = () => {
                const categories = [
                    ...new Set(data.map(item => item.category)),
                    "الأفعال المهمة"
                ];
                const icons = {
                    'المعلومات الشخصية والتعارف': '👤', 
                    'العائلة والأصدقاء': '👨‍👩‍👧', 
                    'الروتين اليومي والهوايات': '☀️', 
                    'الطعام والملابس والتسوق': '🛍️', 
                    'الوقت والتاريخ والفصول': '🕰️', 
                    'الاتجاهات والعناوين': '🗺️', 
                    'الخطط المستقبلية': '🚀', 
                    'الوصف والمقارنة والآراء': '📝', 
                    'الماضي وأنشطة الأمس': '⏪',
                    'الأفعال المهمة': '🗣️'
                };
                sectionsContainer.innerHTML = '';
                categories.forEach(cat => {
                    sectionsContainer.appendChild(createSectionButton(cat, icons[cat] || '⭐'));
                });
            };

            const showQuestions = (category) => {
                questionsContainer.innerHTML = '';
                questionsTitle.textContent = category;
                
                const itemsToShow = category === "الأفعال المهمة" ? verbs : data.filter(q => q.category === category);

                itemsToShow.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'card bg-white rounded-xl shadow-lg p-1 cursor-pointer perspective-[1000px] relative h-40 overflow-hidden transform hover:scale-[1.02] transition-transform duration-200';
                    card.onclick = () => card.classList.toggle('flipped');
                    
                    if (category === "الأفعال المهمة") {
                        card.innerHTML = `
                            <div class="card-flip-inner relative w-full h-full">
                                <div class="card-front p-4 text-center flex flex-col justify-center items-center h-full bg-gradient-to-br from-blue-50 to-indigo-100 rounded-xl">
                                    <p class="text-xl font-bold text-indigo-700">${item.persian}</p>
                                </div>
                                <div class="card-back p-4 text-center flex flex-col justify-center items-center bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-xl h-full">
                                    <p class="text-xl font-semibold">${item.arabic}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        card.innerHTML = `
                            <div class="card-flip-inner relative w-full h-full">
                                <div class="card-front p-5 text-center flex flex-col justify-center items-center h-full bg-gradient-to-br from-green-50 to-teal-100 rounded-xl">
                                    <p class="text-lg font-semibold text-slate-800 mb-2" lang="fa">${item.persianQ}</p>
                                    <p class="text-sm text-slate-500">${item.arabicQ}</p>
                                    <div class="absolute bottom-3 text-xs text-center text-indigo-500 font-semibold opacity-80">اضغط لإظهار الجواب</div>
                                </div>
                                <div class="card-back p-5 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-xl flex flex-col justify-center items-center h-full">
                                    <p class="font-bold mb-2 text-sm opacity-90">الجواب النموذجي:</p>
                                    <p class="text-lg font-semibold" lang="fa">${item.persianA}</p>
                                </div>
                            </div>
                        `;
                    }
                    questionsContainer.appendChild(card);
                });
                showPage('questions-page');
            };

            const showQuizTypeSelection = () => {
                quizContainer.innerHTML = `
                    <div class="text-center p-6 bg-white rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-6 text-indigo-700">اختر نمط الاختبار</h2>
                        <div class="space-y-4">
                            <h3 class="text-xl font-bold text-indigo-700 mt-6 mb-3">اختبار الأسئلة</h3>
                            <button id="start-quiz-persian" class="w-full bg-gradient-to-r from-indigo-600 to-purple-700 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg hover:from-indigo-700 hover:to-purple-800 transition-all duration-300 transform hover:scale-105">
                                اختر الجواب الفارسي
                            </button>
                            <button id="start-quiz-arabic" class="w-full bg-gradient-to-r from-teal-500 to-green-600 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg hover:from-teal-600 hover:to-green-700 transition-all duration-300 transform hover:scale-105">
                                اختر الترجمة العربية
                            </button>
                            
                            <h3 class="text-xl font-bold text-indigo-700 mt-6 mb-3">اختبار الأفعال</h3>
                            <button id="start-quiz-persian-verb" class="w-full bg-gradient-to-r from-blue-500 to-cyan-600 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg hover:from-blue-600 hover:to-cyan-700 transition-all duration-300 transform hover:scale-105">
                                اختبار الأفعال (الفارسي)
                            </button>
                            <button id="start-quiz-arabic-verb" class="w-full bg-gradient-to-r from-orange-500 to-amber-600 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg hover:from-orange-600 hover:to-amber-700 transition-all duration-300 transform hover:scale-105 mt-3">
                                اختبار الأفعال (العربي)
                            </button>
                            <button id="start-quiz-verb-completion-mc" class="w-full bg-gradient-to-r from-pink-500 to-red-600 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg hover:from-pink-600 hover:to-red-700 transition-all duration-300 transform hover:scale-105 mt-3">
                                إكمال الفعل الفارسي
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('start-quiz-persian').onclick = () => startQuiz('persianAnswer', data);
                document.getElementById('start-quiz-arabic').onclick = () => startQuiz('arabicTranslation', data);
                document.getElementById('start-quiz-persian-verb').onclick = () => startQuiz('persianVerb', verbs);
                document.getElementById('start-quiz-arabic-verb').onclick = () => startQuiz('arabicVerb', verbs);
                document.getElementById('start-quiz-verb-completion-mc').onclick = () => startQuiz('verbCompletionMC', verbs);
            };

            const startQuiz = (quizType, questionsSource) => {
                currentQuizType = quizType;
                questionsForQuiz = [...questionsSource].sort(() => 0.5 - Math.random());
                currentQuizQuestionIndex = 0;
                correctAnswersCount = 0;
                wrongAnswersList = [];
                displayQuizQuestion();
            };

            const startQuizOnWrongAnswers = () => {
                if (wrongAnswersList.length > 0) {
                    startQuiz(currentQuizType, wrongAnswersList); 
                } else {
                    quizContainer.innerHTML = `
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                            <strong class="font-bold">عذراً!</strong>
                            <span class="block sm:inline">لا توجد أسئلة خاطئة لإعادة الاختبار عليها.</span>
                            <span class="absolute top-0 bottom-0 left-0 px-4 py-3 cursor-pointer" onclick="this.parentElement.style.display='none'; showQuizTypeSelection();">
                                <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.15a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.15 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
                            </span>
                        </div>
                        <button id="back-to-quiz-selection" class="w-full bg-indigo-600 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg hover:from-indigo-700 hover:to-purple-800 transition-all duration-300 transform hover:scale-105 mt-4">
                            العودة لقائمة الاختبارات
                        </button>
                    `;
                    document.getElementById('back-to-quiz-selection').onclick = showQuizTypeSelection;
                }
            };

            const displayQuizQuestion = () => {
                if (currentQuizQuestionIndex >= questionsForQuiz.length) {
                    // Quiz finished, display results
                    const totalQuestions = questionsForQuiz.length;
                    const percentage = (correctAnswersCount / totalQuestions) * 100;
                    const isPassed = percentage >= 70; // 70% pass mark, can be adjusted

                    let resultMessage = '';
                    let resultColor = '';
                    let resultEmoji = '';
                    let encouragementMessage = '';

                    if (isPassed) {
                        resultMessage = 'أحسنت! لقد نجحت في الاختبار.';
                        resultColor = 'text-green-700';
                        resultEmoji = '🎉';
                        encouragementMessage = 'عمل رائع! استمر في المذاكرة للحفاظ على مستواك.';
                    } else {
                        resultMessage = 'للأسف، لم تنجح في الاختبار.';
                        resultColor = 'text-red-700';
                        resultEmoji = '😔';
                        encouragementMessage = 'لا تقلق، يمكنك التعلم من أخطائك. حاول مجدداً!';
                    }

                    quizContainer.innerHTML = `
                        <div class="bg-gradient-to-br from-blue-50 to-purple-100 p-8 rounded-xl shadow-xl text-center">
                            <h3 class="text-3xl font-bold ${resultColor} mb-4">${resultEmoji} ${resultMessage}</h3>
                            <p class="text-slate-700 text-lg mb-2">النتيجة: <span class="font-bold">${correctAnswersCount} / ${totalQuestions}</span></p>
                            <p class="text-slate-700 text-lg mb-6">النسبة المئوية: <span class="font-bold">${percentage.toFixed(2)}%</span></p>
                            <p class="text-slate-600 text-md mb-8">${encouragementMessage}</p>
                            
                            <button id="restart-quiz" class="w-full bg-gradient-to-r from-indigo-600 to-purple-700 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg hover:from-indigo-700 hover:to-purple-800 transition-all duration-300 transform hover:scale-105 mb-3">
                                العودة لقائمة الاختبارات
                            </button>
                            ${wrongAnswersList.length > 0 ? `
                            <button id="retry-wrong-answers" class="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg hover:from-orange-600 hover:to-red-700 transition-all duration-300 transform hover:scale-105">
                                إعادة الاختبار على الأسئلة الخاطئة (${wrongAnswersList.length})
                            </button>
                            ` : ''}
                        </div>
                    `;
                    document.getElementById('restart-quiz').onclick = showQuizTypeSelection;
                    if (wrongAnswersList.length > 0) {
                        document.getElementById('retry-wrong-answers').onclick = startQuizOnWrongAnswers;
                    }
                    return;
                }

                const question = questionsForQuiz[currentQuizQuestionIndex];
                let correctAnswer, questionText, questionSubText, lang;
                let optionsHtml = ''; // For multiple choice

                // Helper to get unique wrong options
                const getWrongOptions = (allOptions, correctOption, count = 3) => {
                    let uniqueWrongOptions = new Set();
                    const normalizedCorrect = normalizeText(correctOption);
                    
                    // Filter out the correct option and collect unique wrong ones
                    const potentialWrong = allOptions.filter(item => normalizeText(item) !== normalizedCorrect);
                    
                    // Shuffle and take up to 'count' unique options
                    const shuffledPotential = [...potentialWrong].sort(() => 0.5 - Math.random());
                    
                    for (let i = 0; i < shuffledPotential.length && uniqueWrongOptions.size < count; i++) {
                        uniqueWrongOptions.add(shuffledPotential[i]);
                    }

                    // If not enough unique wrong options, fill with duplicates from available wrong options
                    // Or, if there are very few total options, just return what's available
                    if (uniqueWrongOptions.size < count && potentialWrong.length > 0) {
                        while (uniqueWrongOptions.size < count) {
                            uniqueWrongOptions.add(potentialWrong[Math.floor(Math.random() * potentialWrong.length)]);
                        }
                    } else if (potentialWrong.length === 0 && count > 0) {
                        // Edge case: no wrong options available (e.g., only one verb in the list)
                        // In a real app, you might want to skip this question or show fewer options.
                        // For now, we'll just return an empty array for wrong options.
                        return [];
                    }

                    return Array.from(uniqueWrongOptions);
                };


                if (currentQuizType === 'persianAnswer') {
                    questionText = question.persianQ;
                    questionSubText = question.arabicQ;
                    correctAnswer = question.persianA;
                    lang = 'fa';
                    const allPossibleAnswers = data.map(item => item.persianA);
                    const wrongAnswers = getWrongOptions(allPossibleAnswers, correctAnswer);
                    const options = [correctAnswer, ...wrongAnswers].sort(() => 0.5 - Math.random());
                    optionsHtml = options.map(opt => `
                        <button class="quiz-option w-full bg-slate-100 text-slate-700 p-4 rounded-lg border-2 border-slate-200 hover:border-indigo-400 hover:bg-indigo-50 transition-all duration-200 text-right shadow-sm" lang="${lang}" data-answer="${normalizeText(opt) === normalizeText(correctAnswer) ? 'correct' : 'wrong'}" data-question-index="${currentQuizQuestionIndex}">
                            ${opt}
                        </button>
                    `).join('');
                } else if (currentQuizType === 'arabicTranslation') {
                    questionText = question.persianQ;
                    questionSubText = "اختر الترجمة الصحيحة لهذا السؤال";
                    correctAnswer = question.arabicQ;
                    lang = 'ar';
                    const allPossibleAnswers = data.map(item => item.arabicQ);
                    const wrongAnswers = getWrongOptions(allPossibleAnswers, correctAnswer);
                    const options = [correctAnswer, ...wrongAnswers].sort(() => 0.5 - Math.random());
                    optionsHtml = options.map(opt => `
                        <button class="quiz-option w-full bg-slate-100 text-slate-700 p-4 rounded-lg border-2 border-slate-200 hover:border-indigo-400 hover:bg-indigo-50 transition-all duration-200 text-right shadow-sm" lang="${lang}" data-answer="${normalizeText(opt) === normalizeText(correctAnswer) ? 'correct' : 'wrong'}" data-question-index="${currentQuizQuestionIndex}">
                            ${opt}
                        </button>
                    `).join('');
                } else if (currentQuizType === 'persianVerb') {
                    questionText = question.arabic; // Arabic translation is the question
                    questionSubText = "اختر الفعل الفارسي الصحيح";
                    correctAnswer = question.persian; // Persian verb is the correct answer
                    lang = 'fa';
                    const allPossibleVerbs = verbs.map(item => item.persian);
                    const wrongAnswers = getWrongOptions(allPossibleVerbs, correctAnswer);
                    const options = [correctAnswer, ...wrongAnswers].sort(() => 0.5 - Math.random());
                    optionsHtml = options.map(opt => `
                        <button class="quiz-option w-full bg-slate-100 text-slate-700 p-4 rounded-lg border-2 border-slate-200 hover:border-indigo-400 hover:bg-indigo-50 transition-all duration-200 text-right shadow-sm" lang="${lang}" data-answer="${normalizeText(opt) === normalizeText(correctAnswer) ? 'correct' : 'wrong'}" data-question-index="${currentQuizQuestionIndex}">
                            ${opt}
                        </button>
                    `).join('');
                } else if (currentQuizType === 'arabicVerb') {
                    questionText = question.persian; // Persian verb is the question
                    questionSubText = "اختر الترجمة العربية الصحيحة";
                    correctAnswer = question.arabic; // Arabic translation is the correct answer
                    lang = 'ar';
                    const allPossibleVerbs = verbs.map(item => item.arabic);
                    const wrongAnswers = getWrongOptions(allPossibleVerbs, correctAnswer);
                    const options = [correctAnswer, ...wrongAnswers].sort(() => 0.5 - Math.random());
                    optionsHtml = options.map(opt => `
                        <button class="quiz-option w-full bg-slate-100 text-slate-700 p-4 rounded-lg border-2 border-slate-200 hover:border-indigo-400 hover:bg-indigo-50 transition-all duration-200 text-right shadow-sm" lang="${lang}" data-answer="${normalizeText(opt) === normalizeText(correctAnswer) ? 'correct' : 'wrong'}" data-question-index="${currentQuizQuestionIndex}">
                            ${opt}
                        </button>
                    `).join('');
                } else if (currentQuizType === 'verbCompletionMC') { // Verb Completion Multiple Choice Quiz
                    const parts = question.persian.split(' ');
                    const firstPart = parts[0];
                    correctAnswer = parts.slice(1).join(' '); // Second part (or more if verb has multiple parts)
                    
                    questionText = `<span lang="fa">${firstPart}</span> <span class="text-indigo-600 text-3xl font-bold">____</span>`;
                    questionSubText = "اختر الجزء الثاني من الفعل الفارسي";
                    lang = 'fa';

                    // Collect all second parts of verbs for options
                    const allSecondParts = verbs.map(v => v.persian.split(' ').slice(1).join(' '));
                    
                    const wrongOptions = getWrongOptions(allSecondParts, correctAnswer);

                    const options = [correctAnswer, ...wrongOptions].sort(() => 0.5 - Math.random());
                    
                    optionsHtml = options.map(opt => `
                        <button class="quiz-option w-full bg-slate-100 text-slate-700 p-4 rounded-lg border-2 border-slate-200 hover:border-indigo-400 hover:bg-indigo-50 transition-all duration-200 text-right shadow-sm" lang="${lang}" data-answer="${normalizeText(opt) === normalizeText(correctAnswer) ? 'correct' : 'wrong'}" data-question-index="${currentQuizQuestionIndex}">
                            ${opt}
                        </button>
                    `).join('');
                    // Store the full Arabic translation for feedback
                    quizContainer.dataset.correctArabicTranslation = question.arabic;
                }

                quizContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-xl">
                        <p class="text-sm text-slate-500 mb-2 text-center font-semibold">سؤال ${currentQuizQuestionIndex + 1} من ${questionsForQuiz.length}</p>
                        <h3 class="text-xl sm:text-2xl font-bold text-slate-800 mb-2 text-center">${questionText}</h3>
                        <p class="text-sm sm:text-md text-slate-600 mb-4 text-center">${questionSubText}</p>
                        <div id="quiz-options" class="space-y-3">
                            ${optionsHtml}
                        </div>
                        <div id="quiz-feedback" class="mt-4 h-12 flex items-center justify-center"></div>
                    </div>
                `;

                document.querySelectorAll('.quiz-option').forEach(button => {
                    button.onclick = handleAnswerSelection;
                });
            };

            const handleAnswerSelection = (e) => {
                const selectedButton = e.currentTarget;
                const isCorrect = selectedButton.dataset.answer === 'correct';
                const feedbackEl = document.getElementById('quiz-feedback');
                const allOptions = document.querySelectorAll('.quiz-option');
                const questionIndex = parseInt(selectedButton.dataset.questionIndex);

                allOptions.forEach(btn => {
                    btn.disabled = true;
                    if (btn.dataset.answer === 'correct') {
                        btn.classList.remove('bg-slate-100', 'border-slate-200', 'hover:border-indigo-400', 'hover:bg-indigo-50');
                        btn.classList.add('bg-green-200', 'border-green-600', 'text-green-800', 'font-bold');
                    }
                });

                if (isCorrect) {
                    selectedButton.classList.remove('bg-slate-100', 'border-slate-200');
                    selectedButton.classList.add('bg-green-200', 'border-green-600', 'text-green-800', 'font-bold');
                    feedbackEl.innerHTML = `<p class="text-green-600 font-bold text-center text-lg animate-bounce">إجابة صحيحة! 🎉</p>`;
                    correctAnswersCount++;
                } else {
                    selectedButton.classList.remove('bg-slate-100', 'border-slate-200');
                    selectedButton.classList.add('bg-red-200', 'border-red-600', 'text-red-800', 'font-bold');
                    feedbackEl.innerHTML = `<p class="text-red-600 font-bold text-center text-lg animate-pulse">إجابة خاطئة. 😔</p>`;
                    wrongAnswersList.push(questionsForQuiz[questionIndex]);
                }

                // Display Arabic translation for verbCompletionMC type
                if (currentQuizType === 'verbCompletionMC') {
                    const correctTranslation = quizContainer.dataset.correctArabicTranslation;
                    feedbackEl.innerHTML += `<p class="text-slate-700 text-center text-sm mt-2">الترجمة الصحيحة: <span class="font-bold">${correctTranslation}</span></p>`;
                }

                setTimeout(() => {
                    currentQuizQuestionIndex++;
                    displayQuizQuestion();
                }, 1500);
            };

            // --- EVENT LISTENERS ---
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    showPage(item.dataset.page);
                });
            });

            backToHomeBtn.addEventListener('click', () => showPage('home-page'));

            // --- INITIALIZATION ---
            appContainer.classList.add('hidden');
            splashScreen.classList.remove('hidden');

            setTimeout(() => {
                splashScreen.classList.add('fade-out');
                setTimeout(() => {
                    splashScreen.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    displaySections();
                    showPage('home-page');
                }, 500);
            }, 3000);
        });
    </script>
</body>
</html>
